// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© RetailBeastFX Protocol - Professional Trend + ORB System [DUAL-MODE WITH BIG ALERTS]

//@version=5
indicator("RetailBeastFX Protocol [Trend + ORB + Alerts]", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ SYSTEM MODE â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpMode = "System Mode"
string mode = input.string("Standard", "Configuration Mode", options=["Standard", "Optimized", "Custom"], group=grpMode, 
 tooltip="Standard: Original Logic (Safe, Trend-Following)\nOptimized: Enhanced Logic (Aggressive, Reversals, Tighter Risk)\nCustom: Use manual settings below")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ CORE SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpCore = "Core Trend System"
string maType = input.string("EMA", "MA Type", options=["EMA", "SMA", "WMA", "VWMA"], group=grpCore)
int fastLen = input.int(9, "Fast MA Length", minval=1, group=grpCore, tooltip="Faster moving average for short-term trend")
int slowLen = input.int(30, "Slow MA Length", minval=1, group=grpCore, tooltip="Slower moving average for long-term trend")
int rsiLen = input.int(14, "RSI Length", minval=2, group=grpCore)
int rsiOB = input.int(70, "RSI Overbought", minval=50, maxval=100, group=grpCore)
int rsiOS = input.int(25, "RSI Oversold", minval=0, maxval=50, group=grpCore)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ CONSOLIDATION DETECTION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpChop = "Consolidation Filter"
float consolEMAPct = input.float(0.4, "EMA Distance Threshold %", minval=0.1, step=0.1, group=grpChop, 
 tooltip="When MAs are closer than this %, market is consolidating")
float consolMaxMovePct = input.float(0.6, "Max Range Move %", minval=0.1, step=0.1, group=grpChop,
 tooltip="Maximum price movement % to be considered consolidation")
int rangeBarCount = input.int(20, "Range Lookback Bars", minval=5, group=grpChop)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ OPENING RANGE BREAKOUT (ORB) â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpORB = "Opening Range Breakout"
bool orbEnabled = input.bool(true, "Enable ORB System", group=grpORB)
string orbSession = input.session("0930-0945", "ORB Session (NY Time)", group=grpORB,
 tooltip="The opening 15 minutes establishes the range")
string tradingSession = input.session("0930-1600", "Trading Session", group=grpORB)
int orbHoldBars = input.int(15, "ORB Momentum Bars", minval=1, group=grpORB,
 tooltip="How many bars to ride the ORB breakout momentum")

// MODE CONTROLLED INPUTS
bool _blockCounterTrend = input.bool(true, "Block Counter-Trend During ORB", group=grpORB,
 tooltip="[Standard: ON, Optimized: OFF] Prevent short signals during bullish ORB breakout")
bool finalBlockCT = mode == "Standard" ? true : mode == "Optimized" ? false : _blockCounterTrend

bool showORBLines = input.bool(true, "Show ORB Range Lines", group=grpORB)
float orbRetestTol = input.float(30.0, "Retest Tolerance %", minval=1.0, step=0.5, group=grpORB,
 tooltip="How close price needs to get to ORB levels for retest signal")
int maxBarsRetest = input.int(25, "Max Bars for Retest", minval=5, group=grpORB)
int maxBarsFakeout = input.int(15, "Max Bars for Fakeout Detection", minval=1, group=grpORB)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ SESSION FILTER (MODE CONTROLLED) â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpSession = "Session Filter"
bool _useSessionFilter = input.bool(true, "Enforce Trading Session", group=grpSession, 
 tooltip="[Standard: ON, Optimized: OFF] If OFF, trades 24/7. If ON, only trades during 'Trading Session'")
bool finalUseSession = mode == "Standard" ? true : mode == "Optimized" ? false : _useSessionFilter

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ SUPPLY & DEMAND ZONES â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpSD = "Supply & Demand Zones"
bool showSDZones = input.bool(true, "Show S/D Zones", group=grpSD)
int pivotLeft = input.int(10, "Pivot Strength (Left)", minval=1, group=grpSD,
 tooltip="More bars = stronger but fewer pivots")
int pivotRight = input.int(3, "Pivot Confirmation (Right)", minval=1, group=grpSD)
int maxLevels = input.int(20, "Max Active Zones", minval=5, group=grpSD)
int zoneHeightTicks = input.int(28, "Zone Height (Ticks)", minval=1, group=grpSD)
bool showZoneLabels = input.bool(true, "Show Zone Labels", group=grpSD)
color supplyColor = input.color(color.new(color.red, 80), "Supply Color", group=grpSD)
color demandColor = input.color(color.new(color.blue, 80), "Demand Color", group=grpSD)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ VOLUME & MOMENTUM â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpMomentum = "Volume & Momentum"
int volumePeriod = input.int(8, "Volume Average Period", minval=1, group=grpMomentum)

// MODE CONTROLLED INPUTS
float _momentumBodyMult = input.float(1.2, "Strong Candle Body Multiplier", minval=0.5, step=0.1, group=grpMomentum,
 tooltip="[Standard: 1.2, Optimized: 1.1] Candle body must be this many times larger than average")
float finalMomMult = mode == "Standard" ? 1.2 : mode == "Optimized" ? 1.1 : _momentumBodyMult

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ RISK MANAGEMENT â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpRisk = "Risk Management"
float profitFactor = input.float(2.0, "Profit Target (R:R)", minval=0.5, step=0.5, group=grpRisk,
 tooltip="Profit target as multiple of ATR (e.g., 2.0 = 2:1 R:R)")

// MODE CONTROLLED INPUTS
float _stopFactor = input.float(1.0, "Stop Loss Factor", minval=0.5, step=0.1, group=grpRisk,
 tooltip="[Standard: 1.0, Optimized: 0.8] Stop loss as multiple of ATR")
float finalStopFact = mode == "Standard" ? 1.0 : mode == "Optimized" ? 0.8 : _stopFactor

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ VISUAL SETTINGS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpVis = "Visual Settings"
bool showSignals = input.bool(true, "Show Entry Signals", group=grpVis)
bool drawMAs = input.bool(true, "Draw Moving Averages", group=grpVis)
bool fillBackground = input.bool(true, "Fill Background", group=grpVis)
bool showDashboard = input.bool(true, "Show Dashboard", group=grpVis)
bool showBigAlerts = input.bool(true, "Show Big Center Alerts", group=grpVis, tooltip="Large popup boxes with critical trade information")
bool showTradeInstructions = input.bool(true, "Show Trade Instructions", group=grpVis, tooltip="Real-time entry/exit guidance popups")
color bullishCol = input.color(color.green, "Bullish Color", group=grpVis)
color bearishCol = input.color(color.red, "Bearish Color", group=grpVis)
color neutralCol = input.color(color.gray, "Neutral Color", group=grpVis)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ CALCULATIONS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- Moving Averages ---
ma(src, len, type) =>
    switch type
        "EMA" => ta.ema(src, len)
        "SMA" => ta.sma(src, len)
        "WMA" => ta.wma(src, len)
        "VWMA" => ta.vwma(src, len)
        => ta.ema(src, len)

float fastMA = ma(close, fastLen, maType)
float slowMA = ma(close, slowLen, maType)
float rsiVal = ta.rsi(close, rsiLen)

// --- Trend Alignment ---
bool fastUp = fastMA > fastMA[3]
bool fastDn = fastMA < fastMA[3]
bool slowUp = slowMA > slowMA[3]
bool slowDn = slowMA < slowMA[3]

bool bullAlign = fastMA > slowMA and fastUp and slowUp
bool bearAlign = fastMA < slowMA and fastDn and slowDn

// --- Consolidation Detection ---
float maDistPct = (math.abs(fastMA - slowMA) / close) * 100
float rangeHi = ta.highest(high, rangeBarCount)
float rangeLo = ta.lowest(low, rangeBarCount)
float rangeMovePct = ((rangeHi - rangeLo) / rangeLo) * 100

bool isChop = maDistPct < consolEMAPct or rangeMovePct < consolMaxMovePct

// --- Pullback Detection ---
bool pullbackLong = bullAlign and close < fastMA and close > slowMA
bool pullbackShort = bearAlign and close > fastMA and close < slowMA

// --- Volume & Momentum ---
float avgVol = ta.sma(volume, volumePeriod)
bool volConfirm = volume > avgVol

float bodySize = math.abs(close - open)
float avgBody = ta.sma(bodySize, 3)
bool strongBody = bodySize > avgBody * finalMomMult

bool breakPrevHigh = close > high[1]
bool breakPrevLow = close < low[1]

// --- Market State ---
string mktState = isChop ? "CONSOLIDATION" : bullAlign ? "BULLISH" : bearAlign ? "BEARISH" : "NEUTRAL"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ OPENING RANGE BREAKOUT LOGIC â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool inORB = not na(time(timeframe.period, orbSession, "America/New_York"))
bool inSession = finalUseSession ? not na(time(timeframe.period, tradingSession, "America/New_York")) : true

var float orbHigh = na
var float orbLow = na
var bool orbComplete = false
var int orbBarStart = na
var int orbDayKey = na

if dayofweek != orbDayKey
    orbHigh := na
    orbLow := na
    orbComplete := false
    orbBarStart := na
    orbDayKey := dayofweek

if inORB and orbEnabled
    orbHigh := na(orbHigh) ? high : math.max(orbHigh, high)
    orbLow := na(orbLow) ? low : math.min(orbLow, low)
    if na(orbBarStart)
        orbBarStart := bar_index
    if not na(orbHigh) and not na(orbLow)
        orbComplete := true

var int orbBreakDir = 0
var int orbBreakBar = na

bool crossAboveORBHigh = ta.crossover(close, orbHigh)
bool crossBelowORBLow = ta.crossunder(close, orbLow)

if orbComplete and not inORB and orbEnabled
    if crossAboveORBHigh and orbBreakDir == 0
        orbBreakDir := 1
        orbBreakBar := bar_index
    if crossBelowORBLow and orbBreakDir == 0
        orbBreakDir := -1
        orbBreakBar := bar_index

if dayofweek != dayofweek[1]
    orbBreakDir := 0
    orbBreakBar := na

int barsSinceBreak = na(orbBreakBar) ? 999 : bar_index - orbBreakBar
bool inRetestWindow = barsSinceBreak <= maxBarsRetest

float retestTolAmt = (orbHigh - orbLow) * (orbRetestTol / 100)

bool orbRetestLong = orbBreakDir == 1 and inRetestWindow and low <= orbHigh + retestTolAmt and low >= orbHigh - retestTolAmt
bool orbRetestShort = orbBreakDir == -1 and inRetestWindow and high >= orbLow - retestTolAmt and high <= orbLow + retestTolAmt

var float orbMid = na
if orbComplete
    orbMid := math.avg(orbHigh, orbLow)

// Fakeout Detection
bool inFakeoutWindow = barsSinceBreak <= maxBarsFakeout
bool fakeoutLong = orbBreakDir == 1 and inFakeoutWindow and close < orbMid
bool fakeoutShort = orbBreakDir == -1 and inFakeoutWindow and close > orbMid

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ORB VISUALIZATION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var box orbBox = na
var line orbHighLine = na
var line orbLowLine = na
var line orbMidLine = na
var label orbMidLabel = na

bool canDrawORB = not na(orbBarStart) and (last_bar_index - orbBarStart) < 450

if orbComplete and not inORB and inORB[1] and showORBLines and orbEnabled and canDrawORB
    orbBox := box.new(orbBarStart, orbHigh, bar_index, orbLow, border_color=color.new(color.purple, 50), bgcolor=color.new(color.purple, 90), border_width=1)
    orbHighLine := line.new(bar_index, orbHigh, bar_index + 100, orbHigh, color=color.new(color.green, 40), style=line.style_dashed, width=2)
    orbLowLine := line.new(bar_index, orbLow, bar_index + 100, orbLow, color=color.new(color.red, 40), style=line.style_dashed, width=2)
    orbMidLine := line.new(bar_index, orbMid, bar_index + 200, orbMid, color=color.new(color.purple, 30), style=line.style_dotted, width=1)
    orbMidLabel := label.new(bar_index + 205, orbMid, "ORB 50%", style=label.style_none, textcolor=color.purple, size=size.tiny)

if orbComplete and not na(orbHighLine) and showORBLines
    line.set_x2(orbHighLine, bar_index + 1)
    line.set_x2(orbLowLine, bar_index + 1)
    if not na(orbMidLine)
        line.set_x2(orbMidLine, bar_index + 1)
        label.set_x(orbMidLabel, bar_index + 5)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ SUPPLY & DEMAND ZONES â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

float pivHi = ta.pivothigh(high, pivotLeft, pivotRight)
float pivLo = ta.pivotlow(low, pivotLeft, pivotRight)
float tickSize = syminfo.mintick
float zoneHeight = zoneHeightTicks * tickSize

var box[] supplyBoxes = array.new_box()
var box[] demandBoxes = array.new_box()
var label[] supplyLabels = array.new_label()
var label[] demandLabels = array.new_label()

int maxBoxLookback = 450
bool canDrawBox = (last_bar_index - bar_index) < maxBoxLookback

if not na(pivHi) and showSDZones and bar_index > pivotRight and canDrawBox
    int leftBar = bar_index - pivotRight
    int rightBar = bar_index + 50
    float zTop = pivHi
    float zBot = pivHi - zoneHeight
    box newBox = box.new(leftBar, zTop, rightBar, zBot, border_color=color.new(color.red, 50), bgcolor=supplyColor, border_width=1)
    array.push(supplyBoxes, newBox)
    if showZoneLabels
        label newLbl = label.new(leftBar, zTop, "SUPPLY", style=label.style_label_down, color=color.new(color.red, 30), textcolor=color.white, size=size.tiny)
        array.push(supplyLabels, newLbl)
    if array.size(supplyBoxes) > maxLevels
        box.delete(array.shift(supplyBoxes))
        if array.size(supplyLabels) > 0
            label.delete(array.shift(supplyLabels))

if not na(pivLo) and showSDZones and bar_index > pivotRight and canDrawBox
    int leftBar = bar_index - pivotRight
    int rightBar = bar_index + 50
    float zBot = pivLo
    float zTop = pivLo + zoneHeight
    box newBox = box.new(leftBar, zTop, rightBar, zBot, border_color=color.new(color.blue, 50), bgcolor=demandColor, border_width=1)
    array.push(demandBoxes, newBox)
    if showZoneLabels
        label newLbl = label.new(leftBar, zBot, "DEMAND", style=label.style_label_up, color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)
        array.push(demandLabels, newLbl)
    if array.size(demandBoxes) > maxLevels
        box.delete(array.shift(demandBoxes))
        if array.size(demandLabels) > 0
            label.delete(array.shift(demandLabels))

if showSDZones and array.size(supplyBoxes) > 0
    for i = array.size(supplyBoxes) - 1 to 0
        box b = array.get(supplyBoxes, i)
        if close > box.get_top(b)
            box.set_bgcolor(b, color.new(color.red, 95))
            box.delete(b)
            array.remove(supplyBoxes, i)
            if i < array.size(supplyLabels)
                label.delete(array.get(supplyLabels, i))
                array.remove(supplyLabels, i)

if showSDZones and array.size(demandBoxes) > 0
    for i = array.size(demandBoxes) - 1 to 0
        box b = array.get(demandBoxes, i)
        if close < box.get_bottom(b)
            box.set_bgcolor(b, color.new(color.blue, 95))
            box.delete(b)
            array.remove(demandBoxes, i)
            if i < array.size(demandLabels)
                label.delete(array.get(demandLabels, i))
                array.remove(demandLabels, i)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ENTRY SIGNAL LOGIC â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool longBase = bullAlign and not isChop and close > fastMA and volConfirm and strongBody
bool shortBase = bearAlign and not isChop and close < fastMA and volConfirm and strongBody

bool longMomo = bullAlign and close > fastMA and strongBody and breakPrevHigh and not isChop
bool shortMomo = bearAlign and close < fastMA and strongBody and breakPrevLow and not isChop

bool longPullbackEntry = pullbackLong[1] and close > fastMA and not isChop
bool shortPullbackEntry = pullbackShort[1] and close < fastMA and not isChop

bool longRetestEntry = orbRetestLong and bullAlign and not isChop
bool shortRetestEntry = orbRetestShort and bearAlign and not isChop

bool longSignal = (longBase or longMomo or longPullbackEntry or longRetestEntry) and showSignals and inSession
bool shortSignal = (shortBase or shortMomo or shortPullbackEntry or shortRetestEntry) and showSignals and inSession

if finalBlockCT and orbEnabled and orbComplete and barsSinceBreak <= orbHoldBars
    if orbBreakDir == 1
        shortSignal := false
    if orbBreakDir == -1
        longSignal := false

if isChop
    longSignal := false
    shortSignal := false

longSignal := longSignal and not longSignal[1]
shortSignal := shortSignal and not shortSignal[1]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ TARGET & STOP CALCULATION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

float atrVal = ta.atr(14)

var float longTarget = na
var float longStop = na
var float shortTarget = na
var float shortStop = na

if longSignal
    longStop := close - atrVal * finalStopFact
    longTarget := close + atrVal * profitFactor
    shortTarget := na
    shortStop := na

if shortSignal
    shortStop := close + atrVal * finalStopFact
    shortTarget := close - atrVal * profitFactor
    longTarget := na
    longStop := na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ BIG ALERT SYSTEM â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var string currentSetup = ""
var int setupBar = na
var label bigAlertLabel = na

getAlertYPos() =>
    high + (high - low) * 0.3

// CONSOLIDATION ALERT
if isChop and not isChop[1] and showBigAlerts
    label.delete(bigAlertLabel)
    bigAlertLabel := label.new(bar_index, getAlertYPos(), "âš ï¸ CONSOLIDATION âš ï¸\nPrice Action Unclear\nWAIT BEFORE ENTERING", style=label.style_label_center, color=color.new(color.gray, 20), textcolor=color.white, size=size.large)
    currentSetup := "CONSOLIDATION"
    setupBar := bar_index

// FAKEOUT ALERT
if (fakeoutLong or fakeoutShort) and showBigAlerts
    string fakeDir = fakeoutLong ? "BULLISH" : "BEARISH"
    label.delete(bigAlertLabel)
    bigAlertLabel := label.new(bar_index, getAlertYPos(), "âš ï¸ FAKEOUT WARNING âš ï¸\n" + fakeDir + " ORB BREAKOUT FAILED\nWAIT FOR CONFIRMATION", style=label.style_label_center, color=color.new(color.orange, 20), textcolor=color.white, size=size.large)
    currentSetup := "FAKEOUT"
    setupBar := bar_index

// TRADE INSTRUCTION ALERTS
if showTradeInstructions and showBigAlerts
    if bearAlign and pullbackShort and not pullbackShort[1]
        label.delete(bigAlertLabel)
        bigAlertLabel := label.new(bar_index, getAlertYPos(), "ğŸ”´ BEARISH TREND\nBEARISH PULLBACK IN PROGRESS\nACTION: ENTER SHORT ON CONFIRMATION", style=label.style_label_center, color=color.new(color.red, 10), textcolor=color.white, size=size.large)
        currentSetup := "BEARISH PULLBACK"
        setupBar := bar_index
    
    if bullAlign and pullbackLong and not pullbackLong[1]
        label.delete(bigAlertLabel)
        bigAlertLabel := label.new(bar_index, getAlertYPos(), "ğŸŸ¢ BULLISH TREND\nBULLISH PULLBACK IN PROGRESS\nACTION: ENTER LONG ON CONFIRMATION", style=label.style_label_center, color=color.new(color.green, 10), textcolor=color.white, size=size.large)
        currentSetup := "BULLISH PULLBACK"
        setupBar := bar_index
    
    if orbBreakDir == 1 and barsSinceBreak == 0
        label.delete(bigAlertLabel)
        bigAlertLabel := label.new(bar_index, getAlertYPos(), "âš¡ ORB BREAKOUT LONG âš¡\nBULLISH MOMENTUM\nHOLD FOR " + str.tostring(orbHoldBars) + " BARS", style=label.style_label_center, color=color.new(color.green, 10), textcolor=color.white, size=size.large)
        currentSetup := "ORB LONG"
        setupBar := bar_index
    
    if orbBreakDir == -1 and barsSinceBreak == 0
        label.delete(bigAlertLabel)
        bigAlertLabel := label.new(bar_index, getAlertYPos(), "âš¡ ORB BREAKOUT SHORT âš¡\nBEARISH MOMENTUM\nHOLD FOR " + str.tostring(orbHoldBars) + " BARS", style=label.style_label_center, color=color.new(color.red, 10), textcolor=color.white, size=size.large)
        currentSetup := "ORB SHORT"
        setupBar := bar_index
    
    if orbRetestLong and not orbRetestLong[1]
        label.delete(bigAlertLabel)
        bigAlertLabel := label.new(bar_index, getAlertYPos(), "ğŸ¯ RETEST OPPORTUNITY\nORB HIGH RETEST\nHIGH PROBABILITY LONG ENTRY", style=label.style_label_center, color=color.new(color.purple, 10), textcolor=color.white, size=size.large)
        currentSetup := "RETEST LONG"
        setupBar := bar_index
    
    if orbRetestShort and not orbRetestShort[1]
        label.delete(bigAlertLabel)
        bigAlertLabel := label.new(bar_index, getAlertYPos(), "ğŸ¯ RETEST OPPORTUNITY\nORB LOW RETEST\nHIGH PROBABILITY SHORT ENTRY", style=label.style_label_center, color=color.new(color.purple, 10), textcolor=color.white, size=size.large)
        currentSetup := "RETEST SHORT"
        setupBar := bar_index

// Clear alert after 3 bars
if not na(setupBar) and bar_index > setupBar + 3
    label.delete(bigAlertLabel)
    bigAlertLabel := na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ VISUALIZATION â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(drawMAs ? fastMA : na, "Fast MA", color=color.blue, linewidth=2)
plot(drawMAs ? slowMA : na, "Slow MA", color=color.orange, linewidth=2)

color bgCol = isChop ? color.new(neutralCol, 92) : bullAlign ? color.new(bullishCol, 94) : bearAlign ? color.new(bearishCol, 94) : color.new(neutralCol, 96)
bgcolor(fillBackground ? bgCol : na, title="Trend Background")

barcolor(pullbackLong ? color.new(color.orange, 40) : pullbackShort ? color.new(color.orange, 40) : na)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ENTRY SIGNAL LABELS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if longSignal
    label.new(bar_index, low, "â¬†ï¸ LONG\nENTRY", style=label.style_label_up, color=bullishCol, textcolor=color.white, size=size.normal)
    label.new(bar_index, longTarget, "ğŸ¯ TARGET\n" + str.tostring(longTarget, format.mintick), style=label.style_label_left, color=color.new(bullishCol, 30), textcolor=color.white, size=size.small)
    label.new(bar_index, longStop, "âŒ STOP\n" + str.tostring(longStop, format.mintick), style=label.style_label_left, color=color.new(bearishCol, 30), textcolor=color.white, size=size.small)

if shortSignal
    label.new(bar_index, high, "â¬‡ï¸ SHORT\nENTRY", style=label.style_label_down, color=bearishCol, textcolor=color.white, size=size.normal)
    label.new(bar_index, shortTarget, "ğŸ¯ TARGET\n" + str.tostring(shortTarget, format.mintick), style=label.style_label_left, color=color.new(bullishCol, 30), textcolor=color.white, size=size.small)
    label.new(bar_index, shortStop, "âŒ STOP\n" + str.tostring(shortStop, format.mintick), style=label.style_label_left, color=color.new(bearishCol, 30), textcolor=color.white, size=size.small)

if pullbackLong and not pullbackLong[1]
    label.new(bar_index, low, "ğŸŸ  PULLBACK\nWAIT FOR BOUNCE", style=label.style_label_up, color=color.new(color.orange, 40), textcolor=color.white, size=size.small)

if pullbackShort and not pullbackShort[1]
    label.new(bar_index, high, "ğŸŸ  PULLBACK\nWAIT FOR REJECTION", style=label.style_label_down, color=color.new(color.orange, 40), textcolor=color.white, size=size.small)

if orbRetestLong and showSignals
    label.new(bar_index, low, "ğŸ¯ ORB RETEST\nHIGH PROBABILITY", style=label.style_label_up, color=color.new(color.purple, 30), textcolor=color.white, size=size.small)

if orbRetestShort and showSignals
    label.new(bar_index, high, "ğŸ¯ ORB RETEST\nHIGH PROBABILITY", style=label.style_label_down, color=color.new(color.purple, 30), textcolor=color.white, size=size.small)

if isChop and not isChop[1] and not showBigAlerts
    label.new(bar_index, high, "CHOP", style=label.style_label_down, color=color.gray, textcolor=color.white, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ DASHBOARD â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table dash = table.new(position.top_right, 2, 9, bgcolor=color.new(color.black, 85), border_width=2, border_color=color.gray)

if barstate.islast and showDashboard
    table.cell(dash, 0, 0, "RetailBeastFX (" + mode + ")", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 50))
    table.merge_cells(dash, 0, 0, 1, 0)
    
    color stCol = isChop ? neutralCol : bullAlign ? bullishCol : bearAlign ? bearishCol : neutralCol
    table.cell(dash, 0, 1, "Market", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 1, mktState, text_color=stCol, text_size=size.small)
    
    string trendTxt = bullAlign ? "BULLISH â†‘" : bearAlign ? "BEARISH â†“" : "NEUTRAL â†’"
    color trendCol = bullAlign ? bullishCol : bearAlign ? bearishCol : neutralCol
    table.cell(dash, 0, 2, "Trend", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 2, trendTxt, text_color=trendCol, text_size=size.small)
    
    color rsiCol = rsiVal > rsiOB ? bearishCol : rsiVal < rsiOS ? bullishCol : neutralCol
    string rsiLabel = rsiVal > rsiOB ? "OB" : rsiVal < rsiOS ? "OS" : "NEUTRAL"
    table.cell(dash, 0, 3, "RSI", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 3, str.tostring(rsiVal, "#.0") + " (" + rsiLabel + ")", text_color=rsiCol, text_size=size.small)
    
    string orbTxt = not orbEnabled ? "DISABLED" : not orbComplete ? "BUILDING" : orbBreakDir == 1 ? "LONG BREAKOUT" : orbBreakDir == -1 ? "SHORT BREAKOUT" : "RANGING"
    color orbCol = orbBreakDir == 1 ? bullishCol : orbBreakDir == -1 ? bearishCol : neutralCol
    table.cell(dash, 0, 4, "ORB", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 4, orbTxt, text_color=orbCol, text_size=size.small)
    
    string volTxt = volConfirm ? "HIGH âœ“" : "LOW"
    color volCol = volConfirm ? bullishCol : neutralCol
    table.cell(dash, 0, 5, "Volume", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 5, volTxt, text_color=volCol, text_size=size.small)
    
    table.cell(dash, 0, 6, "Setup", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 6, currentSetup, text_color=color.aqua, text_size=size.small)
    
    string zonesTxt = str.tostring(array.size(supplyBoxes)) + " Supply / " + str.tostring(array.size(demandBoxes)) + " Demand"
    table.cell(dash, 0, 7, "S/D Zones", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 7, zonesTxt, text_color=color.aqua, text_size=size.small)
    
    string sessionTxt = inSession ? "ACTIVE (" + (finalUseSession ? "NY" : "24/7") + ")" : "CLOSED"
    color sessionCol = inSession ? bullishCol : neutralCol
    table.cell(dash, 0, 8, "Session", text_color=color.white, text_size=size.small)
    table.cell(dash, 1, 8, sessionTxt, text_color=sessionCol, text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–‘â–‘â–‘ ALERTS â–‘â–‘â–‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(longSignal, title="Long Entry", message="RetailBeastFX: LONG Entry Signal")
alertcondition(shortSignal, title="Short Entry", message="RetailBeastFX: SHORT Entry Signal")
alertcondition(isChop and not isChop[1], title="Consolidation Alert", message="RetailBeastFX: Market Consolidating - Avoid Entries")
alertcondition(orbRetestLong or orbRetestShort, title="ORB Retest", message="RetailBeastFX: ORB Retest Opportunity")
alertcondition(fakeoutLong or fakeoutShort, title="Fakeout Warning", message="âš ï¸ RetailBeastFX: Fakeout Detected!")
